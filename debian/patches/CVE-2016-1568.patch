Backport of:

From 4ab0359a8ae182a7ac5c99609667273167703fab Mon Sep 17 00:00:00 2001
From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Mon, 11 Jan 2016 14:10:42 -0500
Subject: [PATCH] ide: ahci: reset ncq object to unused on error

When processing NCQ commands, AHCI device emulation prepares a
NCQ transfer object; To which an aio control block(aiocb) object
is assigned in 'execute_ncq_command'. In case, when the NCQ
command is invalid, the 'aiocb' object is not assigned, and NCQ
transfer object is left as 'used'. This leads to a use after
free kind of error in 'bdrv_aio_cancel_async' via 'ahci_reset_port'.
Reset NCQ transfer object to 'unused' to avoid it.

[Maintainer edit: s/ACHI/AHCI/ in the commit message. --js]

Reported-by: Qinghao Tang <luodalongde@gmail.com>
Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Reviewed-by: John Snow <jsnow@redhat.com>
Message-id: 1452282511-4116-1-git-send-email-ppandit@redhat.com
Signed-off-by: John Snow <jsnow@redhat.com>
---
 hw/ide/ahci.c |    1 +
 1 files changed, 1 insertions(+), 0 deletions(-)

Index: qemu-2.0.0+dfsg/hw/ide/ahci.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/ide/ahci.c	2016-02-02 07:29:56.668869869 -0500
+++ qemu-2.0.0+dfsg/hw/ide/ahci.c	2016-02-02 07:30:26.677184196 -0500
@@ -826,6 +826,7 @@
         default:
             DPRINTF(port, "error: tried to process non-NCQ command as NCQ\n");
             qemu_sglist_destroy(&ncq_tfs->sglist);
+            ncq_tfs->used = 0;
             break;
     }
 }
